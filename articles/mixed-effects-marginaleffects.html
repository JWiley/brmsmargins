<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Marginal Effects for Mixed Effects Models ‚Ä¢ brmsmargins</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Marginal Effects for Mixed Effects Models">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">brmsmargins</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/fixed-effects-marginaleffects.html">Marginal Effects for Fixed Effects Models</a></li>
    <li><a class="dropdown-item" href="../articles/mixed-effects-marginaleffects.html">Marginal Effects for Mixed Effects Models</a></li>
    <li><a class="dropdown-item" href="../articles/location-scale-marginaleffects.html">Marginal Effects for Location Scale Models</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/JWiley/brmsmargins/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Marginal Effects for Mixed Effects Models</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/JWiley/brmsmargins/blob/main/vignettes/mixed-effects-marginaleffects.Rmd" class="external-link"><code>vignettes/mixed-effects-marginaleffects.Rmd</code></a></small>
      <div class="d-none name"><code>mixed-effects-marginaleffects.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/" class="external-link">knitr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; data.table 1.17.8 using 12 threads (see ?getDTthreads).  Latest news: r-datatable.com</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/paul-buerkner/brms" class="external-link">brms</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: Rcpp</span></span>
<span><span class="co">#&gt; Loading 'brms' package (version 2.23.0). Useful instructions</span></span>
<span><span class="co">#&gt; can be found by typing help('brms'). A more detailed introduction</span></span>
<span><span class="co">#&gt; to the package is available through vignette('brms_overview').</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'brms'</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; The following object is masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     ar</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://joshuawiley.com/brmsmargins/">brmsmargins</a></span><span class="op">)</span></span></code></pre></div>
<p>This vignette provides a brief overview of how to calculate marginal
effects for Bayesian regression models involving only mixed effects
(i.e., fixed and random) and fit using the <code>brms</code>
package.</p>
<div class="section level2">
<h2 id="integrating-out-random-effects">Integrating out Random Effects<a class="anchor" aria-label="anchor" href="#integrating-out-random-effects"></a>
</h2>
<p>A random intercept logistic regression model where a binary (0/1)
outcome,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Y</mi><annotation encoding="application/x-tex">Y</annotation></semantics></math>
is observed at the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>i</mi><mrow><mi>t</mi><mi>h</mi></mrow></msup><annotation encoding="application/x-tex">i^{th}</annotation></semantics></math>
assessment for the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>j</mi><mrow><mi>t</mi><mi>h</mi></mrow></msup><annotation encoding="application/x-tex">j^{th}</annotation></semantics></math>
person and there are
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>p</mi><annotation encoding="application/x-tex">p</annotation></semantics></math>
variables included in the regression model can be written as:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mi>œÄ</mi><mo accent="true">ÃÇ</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Y</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mn>1</mn><mo minsize="1.8" maxsize="1.8" stretchy="false" form="prefix">|</mo><msub><mi>X</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>,</mo><msub><mi>u</mi><mi>j</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>Œ≤</mi><mn>0</mn></msub><mo>+</mo><munderover><mo>‚àë</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>p</mi></munderover><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi><mo>,</mo><mi>k</mi></mrow></msub><msub><mi>Œ≤</mi><mi>k</mi></msub><mo>+</mo><msub><mi>u</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">
\hat{\pi}_{ij} = g \left(P \left( Y_{ij} = 1 \Big| X_{ij} = x_{ij}, u_j \right) \right) = \beta_0 + \sum_{k = 1}^p x_{ij,k} \beta_k + u_j 
</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mo>‚ãÖ</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">g(\cdot)</annotation></semantics></math>
indicates the link function, here the logit</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Œº</mi><mo>=</mo><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>œÄ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>l</mi><mi>n</mi><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><mi>œÄ</mi><mrow><mn>1</mn><mo>‚àí</mo><mi>œÄ</mi></mrow></mfrac><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\mu = g(\pi) = ln\left(\frac{\pi}{1 - \pi}\right)
</annotation></semantics></math></p>
<p>and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>g</mi><mrow><mo>‚àí</mo><mn>1</mn></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><mo>‚ãÖ</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">g^{-1}(\cdot)</annotation></semantics></math>
is the inverse link function:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>œÄ</mi><mo>=</mo><msup><mi>g</mi><mrow><mo>‚àí</mo><mn>1</mn></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>Œº</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><mn>1</mn><mrow><mn>1</mn><mo>+</mo><mi>e</mi><mi>x</mi><mi>p</mi><mrow><mo stretchy="true" form="prefix">(</mo><mo>‚àí</mo><mi>Œº</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac></mrow><annotation encoding="application/x-tex">
\pi = g^{-1}(\mu) = \frac{1}{1 + exp(-\mu)}
</annotation></semantics></math></p>
<p>A conditional predicted probability, conditional on the random effect
can be calculated as:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mi>œÄ</mi><mo accent="true">ÃÇ</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>u</mi><mi>j</mi></msub><mo>=</mo><mn>0</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Y</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mn>1</mn><mo minsize="1.8" maxsize="1.8" stretchy="false" form="prefix">|</mo><msub><mi>X</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>,</mo><msub><mi>u</mi><mi>j</mi></msub><mo>=</mo><mn>0</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msup><mi>g</mi><mrow><mo>‚àí</mo><mn>1</mn></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Œ≤</mi><mn>0</mn></msub><mo>+</mo><munderover><mo>‚àë</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>p</mi></munderover><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi><mo>,</mo><mi>k</mi></mrow></msub><msub><mi>Œ≤</mi><mi>k</mi></msub><mo>+</mo><mn>0</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\hat{\pi}_{ij}(u_j = 0) = 
  P\left(Y_{ij} = 1 \Big| X_{ij} = x_{ij}, u_j = 0 \right) = 
  g^{-1} \left( \beta_0 + \sum_{k = 1}^p x_{ij,k} \beta_k + 0 \right)
</annotation></semantics></math></p>
<p>However, to correctly calculate a prediction that is marginal to the
random effects, the random effects must be integrated out. Not set at a
specific value or set at their mean (0).</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mi>œÄ</mi><mo accent="true">ÃÇ</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Y</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mn>1</mn><mo minsize="1.8" maxsize="1.8" stretchy="false" form="prefix">|</mo><msub><mi>X</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msubsup><mo>‚à´</mo><mrow><mo>‚àí</mo><mi>‚àû</mi></mrow><mi>‚àû</mi></msubsup><msup><mi>g</mi><mrow><mo>‚àí</mo><mn>1</mn></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Œ≤</mi><mn>0</mn></msub><mo>+</mo><munderover><mo>‚àë</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>p</mi></munderover><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi><mo>,</mo><mi>k</mi></mrow></msub><msub><mi>Œ≤</mi><mi>k</mi></msub><mo>+</mo><mi>u</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>u</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><mi>u</mi></mrow><annotation encoding="application/x-tex">
\hat{\pi}_{ij} = 
  P\left(Y_{ij} = 1 \Big| X_{ij} = x_{ij} \right) = 
  \int_{-\infty}^{\infty} g^{-1} \left( \beta_0 + \sum_{k = 1}^p x_{ij,k} \beta_k + u \right)f(u)du
</annotation></semantics></math></p>
<p>Integrating out the random effects analytically can quickly become
complex. For example, it rapidly becomes more complex when there are
multiple random effects, such as if there is more than one grouping or
clustering variable. It also can become more complex when different
distributions are used / assumed.</p>
<p>Monte Carlo integration is a convenient, numerical approach that uses
random samples to approximate the integral. Continuing the simple
example of a logistic regression model where the only random effect is a
random intercept,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>u</mi><mi>j</mi></msub><annotation encoding="application/x-tex">u_j</annotation></semantics></math>
and where we assume that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>u</mi><mi>j</mi></msub><mo>‚àº</mo><mi>ùí©</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><msubsup><mi>œÉ</mi><mi>u</mi><mn>2</mn></msubsup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">u_j \sim \mathcal{N}(0, \sigma^{2}_u)</annotation></semantics></math>,
we could draw
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Q</mi><annotation encoding="application/x-tex">Q</annotation></semantics></math>
random samples, say 100, from
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ùí©</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><msubsup><mi>œÉ</mi><mi>u</mi><mn>2</mn></msubsup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathcal{N}(0, \sigma^{2}_u)</annotation></semantics></math>,
call these
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><msub><mi>E</mi><mi>a</mi></msub></mrow><annotation encoding="application/x-tex">RE_a</annotation></semantics></math>,
then Monte Carlo integration would be:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mi>œÄ</mi><mo accent="true">ÃÇ</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Y</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mn>1</mn><mo minsize="1.8" maxsize="1.8" stretchy="false" form="prefix">|</mo><msub><mi>X</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><mrow><munderover><mo>‚àë</mo><mrow><mi>a</mi><mo>=</mo><mn>1</mn></mrow><mi>Q</mi></munderover><msup><mi>g</mi><mrow><mo>‚àí</mo><mn>1</mn></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Œ≤</mi><mn>0</mn></msub><mo>+</mo><munderover><mo>‚àë</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>p</mi></munderover><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi><mo>,</mo><mi>k</mi></mrow></msub><msub><mi>Œ≤</mi><mi>k</mi></msub><mo>+</mo><mi>R</mi><msub><mi>E</mi><mi>a</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mi>Q</mi></mfrac></mrow><annotation encoding="application/x-tex">
\hat{\pi}_{ij} = 
  P\left(Y_{ij} = 1 \Big| X_{ij} = x_{ij} \right) = 
  \frac{\displaystyle \sum_{a = 1}^{Q} g^{-1} \left( \beta_0 + \sum_{k = 1}^p x_{ij,k} \beta_k + RE_a \right)}{Q}
</annotation></semantics></math></p>
<p>This approach works for most generalized linear mixed models,
although the outcome would not be a probability, necessarily, but
whatever the result of the inverse link function is.</p>
<p>In a Bayesian framework, this approach would be repeated for each
posterior draw as both the regression coefficients and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><msub><mi>E</mi><mi>a</mi></msub></mrow><annotation encoding="application/x-tex">RE_a</annotation></semantics></math>
differs. Because this is repeated across each posterior draw, a very
large number of random draws,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Q</mi><annotation encoding="application/x-tex">Q</annotation></semantics></math>,
for the Monte Carlo integration is probably not needed. Although a
modest number, say
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo>=</mo><mn>100</mn></mrow><annotation encoding="application/x-tex">Q = 100</annotation></semantics></math>,
would have a relatively large amount of simulation error, it is random
error and when repeated across typically thousands of posterior draws,
the impact is likely diminished.</p>
<p>Once we have these marginal predictions, we can calculate marginal
effects using numerical derivatives as:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mfrac><mrow><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Y</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mn>1</mn><mo minsize="1.8" maxsize="1.8" stretchy="false" form="prefix">|</mo><msub><mi>X</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>+</mo><mi>h</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>‚àí</mo><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Y</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mn>1</mn><mo minsize="1.8" maxsize="1.8" stretchy="false" form="prefix">|</mo><msub><mi>X</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mi>h</mi></mfrac><annotation encoding="application/x-tex">
\frac{P\left(Y_{ij} = 1 \Big| X_{ij} = x_{ij} + h \right) - P\left(Y_{ij} = 1 \Big| X_{ij} = x_{ij} \right)}{h}
</annotation></semantics></math></p>
<p>which for a continuous variable provides an approximation of the
derivative, often quite good as long as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>h</mi><annotation encoding="application/x-tex">h</annotation></semantics></math>
is sufficiently small.</p>
</div>
<div class="section level2">
<h2 id="using-brmsmargins">Using <code>brmsmargins()</code><a class="anchor" aria-label="anchor" href="#using-brmsmargins"></a>
</h2>
<p>A simpler introduction and very brief overview and motivation is
available in the vignette for fixed effects only. When there are fixed
and random effects, calculating average marginal effects (AMEs) is more
complicated. Generally, predictions are <strong>conditional</strong> on
the random effects. To deal with this, we need to integrate out the
random effects for every prediction. Please note that this is quite
computationally demanding, at least as currently implemented. For every
predicted value and each posterior draw, random samples from the model
estimated random effects distribution are drawn, added, back
transformed, and averaged.</p>
<p>Thus, if you wanted AMEs across a dataset of 1,000 people, with 2,000
posterior draws, and you wanted to use 100 points for the numerical
integration, a total of 200 million (1,000 x 2,000 x 100) values are
calculated. The monte carlo integration is implemented in C++ code to
try to help speed up the process, but it is not ‚Äúquick‚Äù and also may be
memory intensive.</p>
<p>Because of the complexity involved, only limited types of mixed
effects models are supported.</p>
</div>
<div class="section level2">
<h2 id="mixed-effects-logistic-regression">Mixed Effects Logistic Regression<a class="anchor" aria-label="anchor" href="#mixed-effects-logistic-regression"></a>
</h2>
<p>We will simulate some multilevel binary data for our mixed effects
logistic regression model with individual differences in both the
intercept and slope.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_seed.html" class="external-link">with_seed</a></span><span class="op">(</span></span>
<span>  seed <span class="op">=</span> <span class="fl">12345</span>, code <span class="op">=</span> <span class="op">{</span></span>
<span>    <span class="va">nGroups</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span>    <span class="va">nObs</span> <span class="op">&lt;-</span> <span class="fl">20</span></span>
<span>    <span class="va">theta.location</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">nGroups</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">nGroups</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">theta.location</span> <span class="op">&lt;-</span> <span class="va">theta.location</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/chol.html" class="external-link">chol</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="op">-</span><span class="fl">.25</span>, <span class="op">-</span><span class="fl">.25</span>, <span class="fl">.5</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fl">2.5</span></span>
<span>    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>    <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">1</span>, each <span class="op">=</span> <span class="va">nObs</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span>, times <span class="op">=</span> <span class="va">nGroups</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">d</span><span class="op">[</span>, <span class="va">ID</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">nGroups</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">nObs</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">nGroups</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">d</span><span class="op">[</span><span class="va">ID</span> <span class="op">==</span> <span class="va">i</span>, <span class="va">y</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span></span>
<span>        n <span class="op">=</span> <span class="va">nObs</span>,</span>
<span>        size <span class="op">=</span> <span class="fl">1</span>,</span>
<span>        prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">theta.location</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">theta.location</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">*</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/copy.html" class="external-link">copy</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mlogit</span> <span class="op">&lt;-</span> <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/brm.html" class="external-link">brm</a></span><span class="op">(</span></span>
<span>  <span class="va">y</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">x</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">x</span> <span class="op">|</span> <span class="va">ID</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"bernoulli"</span>,</span>
<span>  data <span class="op">=</span> <span class="va">d</span>, seed <span class="op">=</span> <span class="fl">1234</span>,</span>
<span>  save_pars <span class="op">=</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/save_pars.html" class="external-link">save_pars</a></span><span class="op">(</span>group <span class="op">=</span> <span class="cn">TRUE</span>, latent <span class="op">=</span> <span class="cn">FALSE</span>, all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  prior <span class="op">=</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="op">-</span><span class="fl">2.5</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"Intercept"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">student_t</span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1.25</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"sd"</span>, coef <span class="op">=</span> <span class="st">"Intercept"</span>, group <span class="op">=</span> <span class="st">"ID"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">student_t</span><span class="op">(</span><span class="fl">3</span>, <span class="fl">.5</span>, <span class="fl">.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"sd"</span>, coef <span class="op">=</span> <span class="st">"x"</span>, group <span class="op">=</span> <span class="st">"ID"</span><span class="op">)</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">2</span>, refresh <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4L</span>, cores <span class="op">=</span> <span class="fl">4L</span>, backend <span class="op">=</span> <span class="st">"cmdstanr"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: 24 of 4000 (1.0%) transitions ended with a divergence.</span></span>
<span><span class="co">#&gt; See https://mc-stan.org/misc/warnings for details.</span></span>
<span><span class="co">#&gt; Loading required namespace: rstan</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mlogit</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: There were 24 divergent transitions after warmup. Increasing</span></span>
<span><span class="co">#&gt; adapt_delta above 0.8 may help. See</span></span>
<span><span class="co">#&gt; http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">#&gt;  Family: bernoulli </span></span>
<span><span class="co">#&gt;   Links: mu = logit </span></span>
<span><span class="co">#&gt; Formula: y ~ 1 + x + (1 + x | ID) </span></span>
<span><span class="co">#&gt;    Data: d (Number of observations: 2000) </span></span>
<span><span class="co">#&gt;   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;</span></span>
<span><span class="co">#&gt;          total post-warmup draws = 4000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Multilevel Hyperparameters:</span></span>
<span><span class="co">#&gt; ~ID (Number of levels: 100) </span></span>
<span><span class="co">#&gt;                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">#&gt; sd(Intercept)        1.19      0.18     0.87     1.56 1.00     1130     1850</span></span>
<span><span class="co">#&gt; sd(x)                0.54      0.25     0.06     1.00 1.02      279      506</span></span>
<span><span class="co">#&gt; cor(Intercept,x)    -0.20      0.39    -0.78     0.77 1.00     1625     1284</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Regression Coefficients:</span></span>
<span><span class="co">#&gt;           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">#&gt; Intercept    -2.49      0.19    -2.88    -2.14 1.00     1270     2120</span></span>
<span><span class="co">#&gt; x             0.96      0.17     0.63     1.30 1.00     2403     2217</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Draws were sampled using sample(hmc). For each parameter, Bulk_ESS</span></span>
<span><span class="co">#&gt; and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span><span class="co">#&gt; scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code></pre></div>
<div class="section level3">
<h3 id="ames">AMEs<a class="anchor" aria-label="anchor" href="#ames"></a>
</h3>
<p>Now we can use <code><a href="../reference/brmsmargins.html">brmsmargins()</a></code>. By default, it will only
use the fixed effects. To integrate out random effects, we specify
<code>effects = "integrateoutRE"</code>. The number of values used for
numerical integration are set via the argument, <code>k</code>, here
<code>k = 100L</code>, the default. More details are in:
<code>?brmsmargins:::.predict</code></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">h</span> <span class="op">&lt;-</span> <span class="fl">.001</span></span>
<span><span class="va">ame1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brmsmargins.html">brmsmargins</a></span><span class="op">(</span></span>
<span>  <span class="va">mlogit</span>,</span>
<span>  add <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">h</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  contrasts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="st">"AME x"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span> <span class="op">/</span> <span class="va">h</span>, <span class="fl">1</span> <span class="op">/</span> <span class="va">h</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  effects <span class="op">=</span> <span class="st">"integrateoutRE"</span>, k <span class="op">=</span> <span class="fl">100L</span>, seed <span class="op">=</span> <span class="fl">1234</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">ame1</span><span class="op">$</span><span class="va">ContrastSummary</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="8%">
<col width="6%">
<col width="6%">
<col width="8%">
<col width="16%">
<col width="15%">
<col width="6%">
<col width="9%">
<col width="6%">
<col width="5%">
<col width="8%">
</colgroup>
<thead><tr class="header">
<th align="right">M</th>
<th align="right">Mdn</th>
<th align="right">LL</th>
<th align="right">UL</th>
<th align="right">PercentROPE</th>
<th align="right">PercentMID</th>
<th align="right">CI</th>
<th align="left">CIType</th>
<th align="left">ROPE</th>
<th align="left">MID</th>
<th align="left">Label</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">0.111</td>
<td align="right">0.11</td>
<td align="right">0.06</td>
<td align="right">0.163</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">0.99</td>
<td align="left">HDI</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="left">AME x</td>
</tr></tbody>
</table>
<p>We can follow a similar process getting discrete predictions at x
held at 0 or 1. In this instance, the summary of predictions is more
interesting as well, since they are at meaningfully different values of
<code>x</code>. They also agree quite closely with the average
probability at different <code>x</code> values calculated in the
data.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ame2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brmsmargins.html">brmsmargins</a></span><span class="op">(</span></span>
<span>  <span class="va">mlogit</span>,</span>
<span>  at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  contrasts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="st">"AME x"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  effects <span class="op">=</span> <span class="st">"integrateoutRE"</span>, k <span class="op">=</span> <span class="fl">100L</span>, seed <span class="op">=</span> <span class="fl">1234</span><span class="op">)</span></span></code></pre></div>
<p>Here is a summary of the predictions.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">ame2</span><span class="op">$</span><span class="va">Summary</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<table style="width:100%;" class="table">
<colgroup>
<col width="8%">
<col width="8%">
<col width="8%">
<col width="8%">
<col width="17%">
<col width="16%">
<col width="7%">
<col width="10%">
<col width="7%">
<col width="5%">
</colgroup>
<thead><tr class="header">
<th align="right">M</th>
<th align="right">Mdn</th>
<th align="right">LL</th>
<th align="right">UL</th>
<th align="right">PercentROPE</th>
<th align="right">PercentMID</th>
<th align="right">CI</th>
<th align="left">CIType</th>
<th align="left">ROPE</th>
<th align="left">MID</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">0.118</td>
<td align="right">0.117</td>
<td align="right">0.075</td>
<td align="right">0.175</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">0.99</td>
<td align="left">HDI</td>
<td align="left">NA</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="right">0.228</td>
<td align="right">0.228</td>
<td align="right">0.161</td>
<td align="right">0.305</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">0.99</td>
<td align="left">HDI</td>
<td align="left">NA</td>
<td align="left">NA</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">ame2</span><span class="op">$</span><span class="va">ContrastSummary</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="6%">
<col width="8%">
<col width="6%">
<col width="8%">
<col width="16%">
<col width="15%">
<col width="6%">
<col width="9%">
<col width="6%">
<col width="5%">
<col width="8%">
</colgroup>
<thead><tr class="header">
<th align="right">M</th>
<th align="right">Mdn</th>
<th align="right">LL</th>
<th align="right">UL</th>
<th align="right">PercentROPE</th>
<th align="right">PercentMID</th>
<th align="right">CI</th>
<th align="left">CIType</th>
<th align="left">ROPE</th>
<th align="left">MID</th>
<th align="left">Label</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">0.11</td>
<td align="right">0.109</td>
<td align="right">0.06</td>
<td align="right">0.166</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">0.99</td>
<td align="left">HDI</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="left">AME x</td>
</tr></tbody>
</table>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">d</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>M <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">ID</span>, <span class="va">x</span><span class="op">)</span><span class="op">]</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>M <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">x</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">x</th>
<th align="right">M</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">0</td>
<td align="right">0.117</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">0.228</td>
</tr>
</tbody>
</table>
<p>Note that when integrating out random effects, the random seed is
quite important. If the <code>seed</code> argument is not specified,
<code><a href="../reference/brmsmargins.html">brmsmargins()</a></code> will randomly select one. This would not
matter when generating predictions only from fixed effects, but when
using random samples to integrate out random effects, if different
random seeds are used for different predictions, you would expect some
(small) differences even for the same input data for prediction. This
may not be an issue for predictions on their own. However, when
numerically approximating a derivative by a very small difference in
predictions, such as with <code>h = .001</code> tiny differences are
magnified. To see the impact, consider this example where we explicitly
set multiple random seeds, one for each row of the data used for
predictions. In both cases, we use exactly <code>x = 0</code>, so the
difference is due to Monte Carlo variation only, but with
<code>k = 10L</code> the small error, when divided by
<code>h = .001</code> becomes very large, impossibly so.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">h</span> <span class="op">&lt;-</span> <span class="fl">.001</span></span>
<span><span class="va">ame.error</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brmsmargins.html">brmsmargins</a></span><span class="op">(</span></span>
<span>  <span class="va">mlogit</span>,</span>
<span>  add <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  contrasts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="st">"AME x"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span> <span class="op">/</span> <span class="va">h</span>, <span class="fl">1</span> <span class="op">/</span> <span class="va">h</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  effects <span class="op">=</span> <span class="st">"integrateoutRE"</span>, k <span class="op">=</span> <span class="fl">10L</span>, seed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1234</span>, <span class="fl">54321</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">ame.error</span><span class="op">$</span><span class="va">ContrastSummary</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<table style="width:100%;" class="table">
<colgroup>
<col width="8%">
<col width="8%">
<col width="9%">
<col width="9%">
<col width="14%">
<col width="13%">
<col width="6%">
<col width="8%">
<col width="6%">
<col width="4%">
<col width="7%">
</colgroup>
<thead><tr class="header">
<th align="right">M</th>
<th align="right">Mdn</th>
<th align="right">LL</th>
<th align="right">UL</th>
<th align="right">PercentROPE</th>
<th align="right">PercentMID</th>
<th align="right">CI</th>
<th align="left">CIType</th>
<th align="left">ROPE</th>
<th align="left">MID</th>
<th align="left">Label</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">-0.717</td>
<td align="right">-0.371</td>
<td align="right">-167.14</td>
<td align="right">174.157</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">0.99</td>
<td align="left">HDI</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="left">AME x</td>
</tr></tbody>
</table>
<p>This disappears when we use the same seed for each row of the data
used for predictions. Here we get all zeros for the difference, as we
would expect. Note that you do not need to specify a seed for each row
of the data. You can specify one seed (or rely on
<code><a href="../reference/brmsmargins.html">brmsmargins()</a></code> default), which will then be used for all
rows of the data.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">h</span> <span class="op">&lt;-</span> <span class="fl">.001</span></span>
<span><span class="va">ame.noerror</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brmsmargins.html">brmsmargins</a></span><span class="op">(</span></span>
<span>  <span class="va">mlogit</span>,</span>
<span>  add <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  contrasts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="st">"AME x"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span> <span class="op">/</span> <span class="va">h</span>, <span class="fl">1</span> <span class="op">/</span> <span class="va">h</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  effects <span class="op">=</span> <span class="st">"integrateoutRE"</span>, k <span class="op">=</span> <span class="fl">10L</span>, seed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1234</span>, <span class="fl">1234</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">ame.noerror</span><span class="op">$</span><span class="va">ContrastSummary</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<table style="width:100%;" class="table">
<colgroup>
<col width="4%">
<col width="6%">
<col width="4%">
<col width="4%">
<col width="19%">
<col width="17%">
<col width="7%">
<col width="11%">
<col width="7%">
<col width="6%">
<col width="9%">
</colgroup>
<thead><tr class="header">
<th align="right">M</th>
<th align="right">Mdn</th>
<th align="right">LL</th>
<th align="right">UL</th>
<th align="right">PercentROPE</th>
<th align="right">PercentMID</th>
<th align="right">CI</th>
<th align="left">CIType</th>
<th align="left">ROPE</th>
<th align="left">MID</th>
<th align="left">Label</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">0.99</td>
<td align="left">HDI</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="left">AME x</td>
</tr></tbody>
</table>
</div>
<div class="section level3">
<h3 id="marginal-coefficients">Marginal Coefficients<a class="anchor" aria-label="anchor" href="#marginal-coefficients"></a>
</h3>
<p>The fixed effects coefficients are conditional on the random effects.
To aide interpretation, we also can calculate marginal coefficients or
population averaged coefficients. The function to do this is
<code><a href="../reference/marginalcoef.html">marginalcoef()</a></code> which uses the method described by Hedeker
and colleagues (2018). Here is an example and comparison to results
using a single level logistic regression that ignores the clustering in
the data.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## calculate marginal coefficients</span></span>
<span><span class="va">mc.logit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/marginalcoef.html">marginalcoef</a></span><span class="op">(</span><span class="va">mlogit</span>, CI <span class="op">=</span> <span class="fl">0.95</span>, seed <span class="op">=</span> <span class="fl">1234</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## calculate single level logistic regression</span></span>
<span><span class="va">glm.logit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">x</span>, family <span class="op">=</span> <span class="st">"binomial"</span>, data <span class="op">=</span> <span class="va">d</span><span class="op">)</span></span>
<span><span class="va">glm.logit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>Est <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">glm.logit</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/confint.html" class="external-link">confint</a></span><span class="op">(</span><span class="va">glm.logit</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Waiting for profiling to be done...</span></span></code></pre></div>
<p>Now we can view and compare the results.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span></span>
<span>  <span class="va">mc.logit</span><span class="op">$</span><span class="va">Summary</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>    MargCoef <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%0.3f"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">M</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    MargCoefCI <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"[%0.3f, %0.3f]"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">LL</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">UL</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  <span class="va">glm.logit</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>    GLMCoef <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%0.3f"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">Est</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    GLMCI <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"[%0.3f, %0.3f]"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">`2.5 %`</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">`97.5 %`</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">MargCoef</th>
<th align="left">MargCoefCI</th>
<th align="left">GLMCoef</th>
<th align="left">GLMCI</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">-2.022</td>
<td align="left">[-2.389, -1.666]</td>
<td align="left">-2.021</td>
<td align="left">[-2.219, -1.833]</td>
</tr>
<tr class="even">
<td align="left">0.798</td>
<td align="left">[0.536, 1.075]</td>
<td align="left">0.802</td>
<td align="left">[0.561, 1.047]</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level2">
<h2 id="mixed-effects-poisson-regression">Mixed Effects Poisson Regression<a class="anchor" aria-label="anchor" href="#mixed-effects-poisson-regression"></a>
</h2>
<p>We will simulate some multilevel poisson data for our mixed effects
poisson regression model with individual differences in both the
intercept and slope.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dpoisson</span> <span class="op">&lt;-</span> <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_seed.html" class="external-link">with_seed</a></span><span class="op">(</span></span>
<span>  seed <span class="op">=</span> <span class="fl">12345</span>, code <span class="op">=</span> <span class="op">{</span></span>
<span>    <span class="va">nGroups</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span>    <span class="va">nObs</span> <span class="op">&lt;-</span> <span class="fl">20</span></span>
<span>    <span class="va">theta.location</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">nGroups</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">nGroups</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">theta.location</span> <span class="op">&lt;-</span> <span class="va">theta.location</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/chol.html" class="external-link">chol</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="op">-</span><span class="fl">.25</span>, <span class="op">-</span><span class="fl">.25</span>, <span class="fl">.5</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fl">2.5</span></span>
<span>    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>    <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">1</span>, each <span class="op">=</span> <span class="va">nObs</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span>, times <span class="op">=</span> <span class="va">nGroups</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">d</span><span class="op">[</span>, <span class="va">ID</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">nGroups</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">nObs</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">nGroups</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">d</span><span class="op">[</span><span class="va">ID</span> <span class="op">==</span> <span class="va">i</span>, <span class="va">y</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span></span>
<span>        n <span class="op">=</span> <span class="va">nObs</span>,</span>
<span>        lambda <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">theta.location</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">theta.location</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">*</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/copy.html" class="external-link">copy</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mpois</span> <span class="op">&lt;-</span> <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/brm.html" class="external-link">brm</a></span><span class="op">(</span></span>
<span>  <span class="va">y</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">x</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">x</span> <span class="op">|</span> <span class="va">ID</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"poisson"</span>,</span>
<span>  data <span class="op">=</span> <span class="va">dpoisson</span>, seed <span class="op">=</span> <span class="fl">1234</span>,</span>
<span>  prior <span class="op">=</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="op">-</span><span class="fl">2.5</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"Intercept"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">student_t</span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1.25</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"sd"</span>, coef <span class="op">=</span> <span class="st">"Intercept"</span>, group <span class="op">=</span> <span class="st">"ID"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">student_t</span><span class="op">(</span><span class="fl">3</span>, <span class="fl">.5</span>, <span class="fl">.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"sd"</span>, coef <span class="op">=</span> <span class="st">"x"</span>, group <span class="op">=</span> <span class="st">"ID"</span><span class="op">)</span>,</span>
<span>  save_pars <span class="op">=</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/save_pars.html" class="external-link">save_pars</a></span><span class="op">(</span>group <span class="op">=</span> <span class="cn">TRUE</span>, latent <span class="op">=</span> <span class="cn">FALSE</span>, all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4L</span>, cores <span class="op">=</span> <span class="fl">4L</span>, backend <span class="op">=</span> <span class="st">"cmdstanr"</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">2</span>, refresh <span class="op">=</span> <span class="fl">0</span>, adapt_delta <span class="op">=</span> <span class="fl">0.99</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mpois</span><span class="op">)</span></span>
<span><span class="co">#&gt;  Family: poisson </span></span>
<span><span class="co">#&gt;   Links: mu = log </span></span>
<span><span class="co">#&gt; Formula: y ~ 1 + x + (1 + x | ID) </span></span>
<span><span class="co">#&gt;    Data: dpoisson (Number of observations: 2000) </span></span>
<span><span class="co">#&gt;   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;</span></span>
<span><span class="co">#&gt;          total post-warmup draws = 4000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Multilevel Hyperparameters:</span></span>
<span><span class="co">#&gt; ~ID (Number of levels: 100) </span></span>
<span><span class="co">#&gt;                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">#&gt; sd(Intercept)        1.19      0.15     0.92     1.51 1.00     1370     2517</span></span>
<span><span class="co">#&gt; sd(x)                0.38      0.19     0.03     0.75 1.01      355      891</span></span>
<span><span class="co">#&gt; cor(Intercept,x)    -0.07      0.40    -0.73     0.83 1.00     1614     1003</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Regression Coefficients:</span></span>
<span><span class="co">#&gt;           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">#&gt; Intercept    -2.47      0.18    -2.84    -2.13 1.00     1860     2334</span></span>
<span><span class="co">#&gt; x             0.97      0.15     0.68     1.28 1.00     4302     3080</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Draws were sampled using sample(hmc). For each parameter, Bulk_ESS</span></span>
<span><span class="co">#&gt; and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span><span class="co">#&gt; scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code></pre></div>
<div class="section level3">
<h3 id="ames-1">AMEs<a class="anchor" aria-label="anchor" href="#ames-1"></a>
</h3>
<p>We use <code><a href="../reference/brmsmargins.html">brmsmargins()</a></code> in the same way as for the mixed
effects logistic regression. Here is an example with a numeric
derivative treating <code>x</code> as continuous.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">h</span> <span class="op">&lt;-</span> <span class="fl">.001</span></span>
<span><span class="va">ame1.pois</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brmsmargins.html">brmsmargins</a></span><span class="op">(</span></span>
<span>  <span class="va">mpois</span>,</span>
<span>  add <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">h</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  contrasts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="st">"AME x"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span> <span class="op">/</span> <span class="va">h</span>, <span class="fl">1</span> <span class="op">/</span> <span class="va">h</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  effects <span class="op">=</span> <span class="st">"integrateoutRE"</span>, k <span class="op">=</span> <span class="fl">100L</span>, seed <span class="op">=</span> <span class="fl">1234</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">ame1.pois</span><span class="op">$</span><span class="va">ContrastSummary</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="8%">
<col width="8%">
<col width="8%">
<col width="8%">
<col width="16%">
<col width="14%">
<col width="6%">
<col width="9%">
<col width="6%">
<col width="5%">
<col width="8%">
</colgroup>
<thead><tr class="header">
<th align="right">M</th>
<th align="right">Mdn</th>
<th align="right">LL</th>
<th align="right">UL</th>
<th align="right">PercentROPE</th>
<th align="right">PercentMID</th>
<th align="right">CI</th>
<th align="left">CIType</th>
<th align="left">ROPE</th>
<th align="left">MID</th>
<th align="left">Label</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">0.333</td>
<td align="right">0.312</td>
<td align="right">0.141</td>
<td align="right">0.729</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">0.99</td>
<td align="left">HDI</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="left">AME x</td>
</tr></tbody>
</table>
<p>Here is an example treating <code>x</code> as discrete.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ame2.pois</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brmsmargins.html">brmsmargins</a></span><span class="op">(</span></span>
<span>  <span class="va">mpois</span>,</span>
<span>  at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  contrasts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="st">"AME x"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  effects <span class="op">=</span> <span class="st">"integrateoutRE"</span>, k <span class="op">=</span> <span class="fl">100L</span>, seed <span class="op">=</span> <span class="fl">1234</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">ame2.pois</span><span class="op">$</span><span class="va">ContrastSummary</span><span class="op">)</span></span></code></pre></div>
<table style="width:100%;" class="table">
<colgroup>
<col width="11%">
<col width="11%">
<col width="11%">
<col width="11%">
<col width="13%">
<col width="12%">
<col width="5%">
<col width="7%">
<col width="5%">
<col width="4%">
<col width="6%">
</colgroup>
<thead><tr class="header">
<th align="right">M</th>
<th align="right">Mdn</th>
<th align="right">LL</th>
<th align="right">UL</th>
<th align="right">PercentROPE</th>
<th align="right">PercentMID</th>
<th align="right">CI</th>
<th align="left">CIType</th>
<th align="left">ROPE</th>
<th align="left">MID</th>
<th align="left">Label</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">0.2942814</td>
<td align="right">0.2782104</td>
<td align="right">0.1138293</td>
<td align="right">0.6221603</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">0.99</td>
<td align="left">HDI</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="left">AME x</td>
</tr></tbody>
</table>
</div>
<div class="section level3">
<h3 id="marginal-coefficients-1">Marginal Coefficients<a class="anchor" aria-label="anchor" href="#marginal-coefficients-1"></a>
</h3>
<p>Just as for mixed effects logistic regression, we can calculate
marginal or population averaged coefficients for mixed effects poisson
regression using the same process as described by Hedeker and colleagues
(2018). Here is an example and comparison to results using a single
level poisson regression that ignores the clustering in the data.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## calculate marginal coefficients</span></span>
<span><span class="va">mc.pois</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/marginalcoef.html">marginalcoef</a></span><span class="op">(</span><span class="va">mpois</span>, CI <span class="op">=</span> <span class="fl">0.95</span>, seed <span class="op">=</span> <span class="fl">1234</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## calculate single level logistic regression</span></span>
<span><span class="va">glm.pois</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">x</span>, family <span class="op">=</span> <span class="st">"poisson"</span>, data <span class="op">=</span> <span class="va">d</span><span class="op">)</span></span>
<span><span class="va">glm.pois</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>Est <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">glm.pois</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/confint.html" class="external-link">confint</a></span><span class="op">(</span><span class="va">glm.pois</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Waiting for profiling to be done...</span></span></code></pre></div>
<p>Now we can view and compare the results.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span></span>
<span>  <span class="va">mc.pois</span><span class="op">$</span><span class="va">Summary</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>    MargCoef <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%0.3f"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">M</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    MargCoefCI <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"[%0.3f, %0.3f]"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">LL</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">UL</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  <span class="va">glm.pois</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>    GLMCoef <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%0.3f"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">Est</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    GLMCI <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"[%0.3f, %0.3f]"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">`2.5 %`</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">`97.5 %`</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">MargCoef</th>
<th align="left">MargCoefCI</th>
<th align="left">GLMCoef</th>
<th align="left">GLMCI</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">-1.778</td>
<td align="left">[-2.261, -1.265]</td>
<td align="left">-1.858</td>
<td align="left">[-2.019, -1.705]</td>
</tr>
<tr class="even">
<td align="left">0.989</td>
<td align="left">[0.705, 1.282]</td>
<td align="left">0.983</td>
<td align="left">[0.802, 1.170]</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level2">
<h2 id="mixed-effects-negative-binomial-regression">Mixed Effects Negative Binomial Regression<a class="anchor" aria-label="anchor" href="#mixed-effects-negative-binomial-regression"></a>
</h2>
<p>Negative binomial models work the same way as for poisson models. We
use the same dataset, just for demonstration.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dnb</span> <span class="op">&lt;-</span> <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_seed.html" class="external-link">with_seed</a></span><span class="op">(</span></span>
<span>  seed <span class="op">=</span> <span class="fl">12345</span>, code <span class="op">=</span> <span class="op">{</span></span>
<span>    <span class="va">nGroups</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span>    <span class="va">nObs</span> <span class="op">&lt;-</span> <span class="fl">20</span></span>
<span>    <span class="va">theta.location</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">nGroups</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">nGroups</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">theta.location</span> <span class="op">&lt;-</span> <span class="va">theta.location</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/chol.html" class="external-link">chol</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="op">-</span><span class="fl">.25</span>, <span class="op">-</span><span class="fl">.25</span>, <span class="fl">.5</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fl">2.5</span></span>
<span>    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>    <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">1</span>, each <span class="op">=</span> <span class="va">nObs</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span>, times <span class="op">=</span> <span class="va">nGroups</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">d</span><span class="op">[</span>, <span class="va">ID</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">nGroups</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">nObs</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">nGroups</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">d</span><span class="op">[</span><span class="va">ID</span> <span class="op">==</span> <span class="va">i</span>, <span class="va">y</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/stats/NegBinomial.html" class="external-link">rnbinom</a></span><span class="op">(</span></span>
<span>        n <span class="op">=</span> <span class="va">nObs</span>,</span>
<span>        size <span class="op">=</span> <span class="fl">5</span>,</span>
<span>        mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">theta.location</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">theta.location</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">*</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/copy.html" class="external-link">copy</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mnb</span> <span class="op">&lt;-</span> <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/brm.html" class="external-link">brm</a></span><span class="op">(</span></span>
<span>  <span class="va">y</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">x</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">x</span> <span class="op">|</span> <span class="va">ID</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"negbinomial"</span>,</span>
<span>  data <span class="op">=</span> <span class="va">dnb</span>, seed <span class="op">=</span> <span class="fl">1234</span>,</span>
<span>  save_pars <span class="op">=</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/save_pars.html" class="external-link">save_pars</a></span><span class="op">(</span>group <span class="op">=</span> <span class="cn">TRUE</span>, latent <span class="op">=</span> <span class="cn">FALSE</span>, all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4L</span>, cores <span class="op">=</span> <span class="fl">4L</span>, backend <span class="op">=</span> <span class="st">"cmdstanr"</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">2</span>, refresh <span class="op">=</span> <span class="fl">0</span>, adapt_delta <span class="op">=</span> <span class="fl">0.99</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mnb</span><span class="op">)</span></span>
<span><span class="co">#&gt;  Family: negbinomial </span></span>
<span><span class="co">#&gt;   Links: mu = log </span></span>
<span><span class="co">#&gt; Formula: y ~ 1 + x + (1 + x | ID) </span></span>
<span><span class="co">#&gt;    Data: dnb (Number of observations: 2000) </span></span>
<span><span class="co">#&gt;   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;</span></span>
<span><span class="co">#&gt;          total post-warmup draws = 4000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Multilevel Hyperparameters:</span></span>
<span><span class="co">#&gt; ~ID (Number of levels: 100) </span></span>
<span><span class="co">#&gt;                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">#&gt; sd(Intercept)        1.19      0.17     0.89     1.56 1.01     1038     2109</span></span>
<span><span class="co">#&gt; sd(x)                0.52      0.21     0.06     0.92 1.02      350      436</span></span>
<span><span class="co">#&gt; cor(Intercept,x)    -0.30      0.31    -0.78     0.45 1.01     1496     1350</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Regression Coefficients:</span></span>
<span><span class="co">#&gt;           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">#&gt; Intercept    -2.51      0.19    -2.92    -2.15 1.00     1619     1933</span></span>
<span><span class="co">#&gt; x             1.01      0.17     0.69     1.38 1.00     2231     2341</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Further Distributional Parameters:</span></span>
<span><span class="co">#&gt;       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">#&gt; shape  1969.21  48049.95     2.72  1417.87 1.00     1580      767</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Draws were sampled using sample(hmc). For each parameter, Bulk_ESS</span></span>
<span><span class="co">#&gt; and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span><span class="co">#&gt; scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code></pre></div>
<div class="section level3">
<h3 id="ames-2">AMEs<a class="anchor" aria-label="anchor" href="#ames-2"></a>
</h3>
<p>We use <code><a href="../reference/brmsmargins.html">brmsmargins()</a></code> in the same way as for the mixed
effects poisson regression. Here is an example with a numeric derivative
treating <code>x</code> as continuous.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">h</span> <span class="op">&lt;-</span> <span class="fl">.001</span></span>
<span><span class="va">ame1.nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brmsmargins.html">brmsmargins</a></span><span class="op">(</span></span>
<span>  <span class="va">mnb</span>,</span>
<span>  add <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">h</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  contrasts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="st">"AME x"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span> <span class="op">/</span> <span class="va">h</span>, <span class="fl">1</span> <span class="op">/</span> <span class="va">h</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  effects <span class="op">=</span> <span class="st">"integrateoutRE"</span>, k <span class="op">=</span> <span class="fl">100L</span>, seed <span class="op">=</span> <span class="fl">1234</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">ame1.nb</span><span class="op">$</span><span class="va">ContrastSummary</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="8%">
<col width="6%">
<col width="8%">
<col width="6%">
<col width="16%">
<col width="15%">
<col width="6%">
<col width="9%">
<col width="6%">
<col width="5%">
<col width="8%">
</colgroup>
<thead><tr class="header">
<th align="right">M</th>
<th align="right">Mdn</th>
<th align="right">LL</th>
<th align="right">UL</th>
<th align="right">PercentROPE</th>
<th align="right">PercentMID</th>
<th align="right">CI</th>
<th align="left">CIType</th>
<th align="left">ROPE</th>
<th align="left">MID</th>
<th align="left">Label</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">0.297</td>
<td align="right">0.28</td>
<td align="right">0.125</td>
<td align="right">0.65</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">0.99</td>
<td align="left">HDI</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="left">AME x</td>
</tr></tbody>
</table>
<p>Here is an example treating <code>x</code> as discrete.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ame2.nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brmsmargins.html">brmsmargins</a></span><span class="op">(</span></span>
<span>  <span class="va">mnb</span>,</span>
<span>  at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  contrasts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="st">"AME x"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  effects <span class="op">=</span> <span class="st">"integrateoutRE"</span>, k <span class="op">=</span> <span class="fl">100L</span>, seed <span class="op">=</span> <span class="fl">1234</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">ame2.nb</span><span class="op">$</span><span class="va">ContrastSummary</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<table style="width:100%;" class="table">
<colgroup>
<col width="8%">
<col width="8%">
<col width="6%">
<col width="8%">
<col width="16%">
<col width="15%">
<col width="6%">
<col width="9%">
<col width="6%">
<col width="5%">
<col width="8%">
</colgroup>
<thead><tr class="header">
<th align="right">M</th>
<th align="right">Mdn</th>
<th align="right">LL</th>
<th align="right">UL</th>
<th align="right">PercentROPE</th>
<th align="right">PercentMID</th>
<th align="right">CI</th>
<th align="left">CIType</th>
<th align="left">ROPE</th>
<th align="left">MID</th>
<th align="left">Label</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">0.258</td>
<td align="right">0.245</td>
<td align="right">0.11</td>
<td align="right">0.552</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">0.99</td>
<td align="left">HDI</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="left">AME x</td>
</tr></tbody>
</table>
</div>
<div class="section level3">
<h3 id="marginal-coefficients-2">Marginal Coefficients<a class="anchor" aria-label="anchor" href="#marginal-coefficients-2"></a>
</h3>
<p>Negative binomial models cannot be fit by the <code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm()</a></code>
function in <code>R</code> so we just show the population averaged
values from <code>brms</code>.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## calculate marginal coefficients</span></span>
<span><span class="va">mc.nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/marginalcoef.html">marginalcoef</a></span><span class="op">(</span><span class="va">mnb</span>, CI <span class="op">=</span> <span class="fl">0.95</span>, seed <span class="op">=</span> <span class="fl">1234</span><span class="op">)</span></span></code></pre></div>
<p>View the results.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span></span>
<span>  <span class="va">mc.nb</span><span class="op">$</span><span class="va">Summary</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>    MargCoef <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%0.3f"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">M</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    MargCoefCI <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"[%0.3f, %0.3f]"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">LL</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">UL</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">MargCoef</th>
<th align="left">MargCoefCI</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">-1.805</td>
<td align="left">[-2.296, -1.264]</td>
</tr>
<tr class="even">
<td align="left">0.929</td>
<td align="left">[0.590, 1.301]</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level2">
<h2 id="centered-categorical-predictors">Centered Categorical Predictors<a class="anchor" aria-label="anchor" href="#centered-categorical-predictors"></a>
</h2>
<p>In mixed effects models, it is common to center continuous
predictors. Consider a longitudinal study where sleep was collected
nightly for a week in multiple people. Hours of sleep duration will have
variation that exists between people (different people have different
typical or average sleep durations) and within people (the same person
will sleep different amounts on different nights).</p>
<p>Entering observed hours of sleep duration as a predictor in the model
will conflate associations between sleep duration and the outcome that
exist at the between person and within person level.</p>
<p>Here is a small example for two people with observed sleep (‚ÄúSleep‚Äù),
the between person component, the average sleep per person (‚ÄúBSleep‚Äù),
and the within person sleep, the person centered sleep duration
(‚ÄúWSleep‚Äù).</p>
<table class="table">
<thead><tr class="header">
<th align="center">ID</th>
<th align="center">Sleep</th>
<th align="center">BSleep</th>
<th align="center">WSleep</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">1</td>
<td align="center">6</td>
<td align="center">7</td>
<td align="center">-1</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="center">7</td>
<td align="center">7</td>
<td align="center">0</td>
</tr>
<tr class="odd">
<td align="center">1</td>
<td align="center">8</td>
<td align="center">7</td>
<td align="center">+1</td>
</tr>
<tr class="even">
<td align="center">2</td>
<td align="center">4</td>
<td align="center">5</td>
<td align="center">-1</td>
</tr>
<tr class="odd">
<td align="center">2</td>
<td align="center">5</td>
<td align="center">5</td>
<td align="center">0</td>
</tr>
<tr class="even">
<td align="center">2</td>
<td align="center">6</td>
<td align="center">5</td>
<td align="center">+1</td>
</tr>
</tbody>
</table>
<p>These values are obtained by averaging the observed sleep values by
ID. Then by taking the difference between the observed sleep duration
values and the between person mean sleep values, thus:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><mi>S</mi><mi>l</mi><mi>e</mi><mi>e</mi><mi>p</mi><mo>=</mo><mi>S</mi><mi>l</mi><mi>e</mi><mi>e</mi><mi>p</mi><mo>‚àí</mo><mi>B</mi><mi>S</mi><mi>l</mi><mi>e</mi><mi>e</mi><mi>p</mi></mrow><annotation encoding="application/x-tex">
WSleep = Sleep - BSleep
</annotation></semantics></math></p>
<p>Both <code>BSleep</code> and <code>WSleep</code> could be included as
predictor variables in a model, or if the interest is solely in the
within person association, <code>WSleep</code> only included.</p>
<p>This type of centering is relatively common in mixed effects or
multilevel models, at least for continuous predictors. The presence, or
absence, of such centering for continuous variables has relatively
little bearing on calculating the average marginal effects (AMEs) as
generally both variables remain continuous and a derivative makes
sense.</p>
<p>In contrast to continuous predictors where it is common, it is
relatively <em>un</em>common to center categorical predictors. However,
research (Yaremych, Preacher, &amp; Hedeker, 2021) highlights how the
same rationale that apply to continuous predictors, in regards to the
benefits of centering, equally apply to categorical predictors. One area
where particular attention has been paid to the importance of centering,
whether continuous or categorical predictors, are in individual
participant data meta analyses (IPDMA) with one stage analyses. In these
IPDMA where there are treatment x covariate interactions to evaluate
effect modifiers, centering the predictor / covariate is critical for
avoiding ‚Äòecological bias‚Äô (Hua et al., 2017).</p>
<p>Yaremych et al (2021) showed that an equivalent algebraic approach to
creating centered continuous variables can be applied to categorical
variables, after coding (e.g., using dummy coding). In the same study
used for the continuous example, suppose that whether or not people had
a good night‚Äôs sleep was recorded dummy coded as yes = 1 and no = 0.
This table shows how it might be centered.</p>
<table class="table">
<thead><tr class="header">
<th align="center">ID</th>
<th align="center">GoodSleep</th>
<th align="center">BSleep</th>
<th align="center">WSleep</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">1</td>
<td align="center">0</td>
<td align="center">0.50</td>
<td align="center">-0.50</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="center">0</td>
<td align="center">0.50</td>
<td align="center">-0.50</td>
</tr>
<tr class="odd">
<td align="center">1</td>
<td align="center">1</td>
<td align="center">0.50</td>
<td align="center">+0.50</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="center">1</td>
<td align="center">0.50</td>
<td align="center">+0.50</td>
</tr>
<tr class="odd">
<td align="center">2</td>
<td align="center">0</td>
<td align="center">0.75</td>
<td align="center">-0.75</td>
</tr>
<tr class="even">
<td align="center">2</td>
<td align="center">1</td>
<td align="center">0.75</td>
<td align="center">+0.25</td>
</tr>
<tr class="odd">
<td align="center">2</td>
<td align="center">1</td>
<td align="center">0.75</td>
<td align="center">+0.25</td>
</tr>
<tr class="even">
<td align="center">2</td>
<td align="center">1</td>
<td align="center">0.75</td>
<td align="center">+0.25</td>
</tr>
<tr class="odd">
<td align="center">3</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
</tr>
<tr class="even">
<td align="center">3</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
</tr>
<tr class="odd">
<td align="center">3</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
</tr>
<tr class="even">
<td align="center">3</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
</tr>
</tbody>
</table>
<p>We can include these new variables as predictors in a model just as
any other predictors. However, in contrast to the continuous case where
for the AMEs we tend to calculate a derivative, the categorical case is
more challenging. Typically, for categorical variables, AMEs are
calculated as the AME moving from one category to another category. This
can easily be accomplished in <code>brmsmargins</code> using the
<code>at</code> argument. However, when a categorical variable is
centered by ID, the values for one category are not constant by ID.</p>
<p>To address, this, <code>brmsmargins</code> implements an additional
argument, <code>wat</code> for within level <code>at</code>. This
argument is used to give the values to be used at each ID level. The
<code>wat</code> argument is used in conjuction with the <code>at</code>
argument. The <code>at</code> argument continues to be used for the
general setup, with <code>wat</code> used for the specific values.</p>
<p>This is more easily shown than said. Here we simulate some multilevel
data with a binary predictor, <code>x</code> and a binary outcome,
<code>y</code>.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_seed.html" class="external-link">with_seed</a></span><span class="op">(</span></span>
<span>  seed <span class="op">=</span> <span class="fl">12345</span>, code <span class="op">=</span> <span class="op">{</span></span>
<span>    <span class="va">nGroups</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span>    <span class="va">nObs</span> <span class="op">&lt;-</span> <span class="fl">20</span></span>
<span>    <span class="va">theta.location</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">nGroups</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">nGroups</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">theta.location</span> <span class="op">&lt;-</span> <span class="va">theta.location</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/chol.html" class="external-link">chol</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="op">-</span><span class="fl">.25</span>, <span class="op">-</span><span class="fl">.25</span>, <span class="fl">.5</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fl">2.5</span></span>
<span>    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span></span>
<span>    <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>ID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">nGroups</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">d</span> <span class="op">&lt;-</span> <span class="va">d</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">nObs</span>, size <span class="op">=</span> <span class="fl">1</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">ID</span><span class="op">]</span></span>
<span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">nGroups</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">d</span><span class="op">[</span><span class="va">ID</span> <span class="op">==</span> <span class="va">i</span>, <span class="va">y</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span></span>
<span>        n <span class="op">=</span> <span class="va">nObs</span>,</span>
<span>        size <span class="op">=</span> <span class="fl">1</span>,</span>
<span>        prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">theta.location</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">theta.location</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">*</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/copy.html" class="external-link">copy</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Now we can create a between and within person version of
<code>x</code>, which we will call <code>xb</code> and <code>xw</code>.
We also fit the <code>brms</code> model, using <code>xw</code>. In this
instance we are not interested in any between person effects, so that
variable is omitted. Any variation not explained by it will go into the
random intercept, anyways.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## within person centering binary predictor</span></span>
<span><span class="va">d</span><span class="op">[</span>, <span class="va">xb</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">ID</span><span class="op">]</span></span>
<span><span class="va">d</span><span class="op">[</span>, <span class="va">xw</span> <span class="op">:=</span> <span class="va">x</span> <span class="op">-</span> <span class="va">xb</span><span class="op">]</span></span>
<span></span>
<span><span class="va">mlogitcent</span> <span class="op">&lt;-</span> <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/brm.html" class="external-link">brm</a></span><span class="op">(</span></span>
<span>  <span class="va">y</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">xw</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">xw</span> <span class="op">|</span> <span class="va">ID</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"bernoulli"</span>,</span>
<span>  data <span class="op">=</span> <span class="va">d</span>, seed <span class="op">=</span> <span class="fl">1234</span>,</span>
<span>  save_pars <span class="op">=</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/save_pars.html" class="external-link">save_pars</a></span><span class="op">(</span>group <span class="op">=</span> <span class="cn">TRUE</span>, latent <span class="op">=</span> <span class="cn">FALSE</span>, all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">2</span>, refresh <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4L</span>, cores <span class="op">=</span> <span class="fl">4L</span>, backend <span class="op">=</span> <span class="st">"cmdstanr"</span><span class="op">)</span></span></code></pre></div>
<p>Now comes the new part. Based on how we coded our predictor,
<code>x</code>, we will create the two values by ID. In this case,
<code>x</code> was coded as 0 and 1. So we start with 0 as the low value
and 1 as the high value. Then we need to take the difference between 0
and 1 with the mean by ID. We (arbitrarily) label these <code>a</code>
and <code>b</code>. We could have chosen any label, <code>min</code> and
<code>max</code> or <code>low</code> and <code>high</code> or whatever
we wanted. It just needs to be distinct and something that
<code><a href="../reference/brmsmargins.html">brmsmargins()</a></code> can match between the <code>at</code> and the
<code>wat</code> arguments. The resulting data get turned into a single
long <code>data.table</code>, called <code>xwid</code>. We use this to
create a list, saved as <code>usewat</code>. The list must have two
elements at a minimum:</p>
<ol style="list-style-type: decimal">
<li>A named element, named ‚ÄúID‚Äù that contains a character string with
the name of the ID variable.</li>
<li>An element named after the centered variable, with a
<code>data.frame</code> or <code>data.table</code> containing the values
to use for each ID and for each label we chose, here <code>a</code> and
<code>b</code>.</li>
</ol>
<p>The table shows a few examples of what the dataset looks like.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">xwid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/melt.data.table.html" class="external-link">melt</a></span><span class="op">(</span></span>
<span>  <span class="va">d</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>a <span class="op">=</span> <span class="fl">0</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="va">xb</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>        b <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="va">xb</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="va">ID</span><span class="op">]</span>, id.vars <span class="op">=</span> <span class="st">"ID"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">usewat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ID <span class="op">=</span> <span class="st">"ID"</span>, xw <span class="op">=</span> <span class="va">xwid</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">xwid</span><span class="op">[</span><span class="va">ID</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">4</span>, <span class="fl">100</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">ID</span><span class="op">)</span><span class="op">]</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">ID</th>
<th align="left">variable</th>
<th align="right">value</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="left">a</td>
<td align="right">0.00</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="left">b</td>
<td align="right">1.00</td>
</tr>
<tr class="odd">
<td align="right">2</td>
<td align="left">a</td>
<td align="right">-0.30</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="left">b</td>
<td align="right">0.70</td>
</tr>
<tr class="odd">
<td align="right">4</td>
<td align="left">a</td>
<td align="right">-1.00</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="left">b</td>
<td align="right">0.00</td>
</tr>
<tr class="odd">
<td align="right">100</td>
<td align="left">a</td>
<td align="right">-0.15</td>
</tr>
<tr class="even">
<td align="right">100</td>
<td align="left">b</td>
<td align="right">0.85</td>
</tr>
</tbody>
</table>
<p>This new dataset shows what values to use for moving from one
category of <code>x</code> to another category of <code>x</code> looks
like, for each ID. Note that sometimes these are the same. In the case
of ID 1, all <code>x</code> values were identical and thus all
<code>xw</code> values will be 0. This is appropriate because for that
ID, there was no variation on <code>x</code> and so we have no idea what
the ‚Äútrue‚Äù change for ID 1 would be if moving from one category to
another.</p>
<p>Now we can use <code><a href="../reference/brmsmargins.html">brmsmargins()</a></code> to calculate the AME. We
must still specify the <code>at</code> argument. Here we use our
arbitrary lables of <code>a</code> and <code>b</code> for the variable,
<code>xw</code>. We also pass our list to the argument <code>wat</code>.
Internally, <code><a href="../reference/brmsmargins.html">brmsmargins()</a></code> will substitute <code>a</code>
for all the values for <code>a</code> by ID from our list, and similarly
for <code>b</code>. The reason for this separation is in the
<code>at</code> argument, one might have specific values of other
variables as well, had there been other predictors in the model.</p>
<p>The resulting summary gives the average marginal predictions for
<code>xw = a</code> and <code>xw = b</code> which in our case refers to
when <code>xw</code> is at 0 on <code>x</code> <strong>for that
ID</strong> and when it is at 1 for <code>x</code> <strong>for that
ID</strong>.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ame.cent</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brmsmargins.html">brmsmargins</a></span><span class="op">(</span></span>
<span>  object <span class="op">=</span> <span class="va">mlogitcent</span>,</span>
<span>  at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>xw <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  wat <span class="op">=</span> <span class="va">usewat</span>,</span>
<span>  contrasts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="st">"AME xw"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  effects <span class="op">=</span> <span class="st">"integrateoutRE"</span>, k <span class="op">=</span> <span class="fl">20L</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">ame.cent</span><span class="op">$</span><span class="va">Summary</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<table style="width:100%;" class="table">
<colgroup>
<col width="8%">
<col width="8%">
<col width="8%">
<col width="8%">
<col width="17%">
<col width="16%">
<col width="7%">
<col width="10%">
<col width="7%">
<col width="5%">
</colgroup>
<thead><tr class="header">
<th align="right">M</th>
<th align="right">Mdn</th>
<th align="right">LL</th>
<th align="right">UL</th>
<th align="right">PercentROPE</th>
<th align="right">PercentMID</th>
<th align="right">CI</th>
<th align="left">CIType</th>
<th align="left">ROPE</th>
<th align="left">MID</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">0.122</td>
<td align="right">0.119</td>
<td align="right">0.052</td>
<td align="right">0.214</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">0.99</td>
<td align="left">HDI</td>
<td align="left">NA</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="right">0.231</td>
<td align="right">0.228</td>
<td align="right">0.128</td>
<td align="right">0.357</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">0.99</td>
<td align="left">HDI</td>
<td align="left">NA</td>
<td align="left">NA</td>
</tr>
</tbody>
</table>
<p>Just as in other examples, we can get a summary of the contrast of
these two values, our AME.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">ame.cent</span><span class="op">$</span><span class="va">ContrastSummary</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="8%">
<col width="8%">
<col width="8%">
<col width="8%">
<col width="16%">
<col width="14%">
<col width="6%">
<col width="9%">
<col width="6%">
<col width="5%">
<col width="9%">
</colgroup>
<thead><tr class="header">
<th align="right">M</th>
<th align="right">Mdn</th>
<th align="right">LL</th>
<th align="right">UL</th>
<th align="right">PercentROPE</th>
<th align="right">PercentMID</th>
<th align="right">CI</th>
<th align="left">CIType</th>
<th align="left">ROPE</th>
<th align="left">MID</th>
<th align="left">Label</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">0.109</td>
<td align="right">0.107</td>
<td align="right">0.043</td>
<td align="right">0.179</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">0.99</td>
<td align="left">HDI</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="left">AME xw</td>
</tr></tbody>
</table>
</div>
<div class="section level2">
<h2 id="interactions-and-marginal-effects">Interactions and Marginal Effects<a class="anchor" aria-label="anchor" href="#interactions-and-marginal-effects"></a>
</h2>
<p>As a final example, we will look at a model with an interaction.
Specifically we have a binary outcome, <code>y</code>, measured
repeatedly. A binary predictor, <code>x</code> measured repeatedly
within units and group membership, <code>Group</code>, a binary variable
that is constant within units so only varies between units.</p>
<p>To map these to a concrete potential research question, suppose that
100 people were randomized 1:1 to either a waitlist control group (Group
= 0) or an emotion regulation intervention designed to help manage
stress (Group = 1). After completing the intervention, participants
completed 20 days of daily diaries. Sleep was recorded each day and
categorized as a good night sleep (<code>y</code> = 1) or a poor night
sleep (<code>y</code> = 0). Each day participants‚Äô also reported whether
they experienced no stressor (<code>x</code> = 0) or any stressor
(<code>x</code> = 1).</p>
<p>The goal is to examine whether the intervention group moderates
participants‚Äô stress reactivity, defined as the association between
experiencing a stressor or not on a given day and whether they have good
or poor sleep that night. Based on clinical judgement and the
intervention cost, it is estimated that any probability difference of
plus or minus 2% is practically equivalent, so the region of practical
equivalence (ROPE) is set at -0.02 to +0.02. A probability difference of
5% or more is considered the minimally important difference (MID), the
smallest difference that is clinically meaningful. Thus the MID is set
at less than or equal to -0.05 or greater than or equal to +0.05.</p>
<p>To show this example, we first simulate a dataset, using a similar
process as in previous examples.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_seed.html" class="external-link">with_seed</a></span><span class="op">(</span></span>
<span>  seed <span class="op">=</span> <span class="fl">12345</span>, code <span class="op">=</span> <span class="op">{</span></span>
<span>    <span class="va">nGroups</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span>    <span class="va">nObs</span> <span class="op">&lt;-</span> <span class="fl">20</span></span>
<span>    <span class="va">theta.location</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">nGroups</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">nGroups</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">theta.location</span> <span class="op">&lt;-</span> <span class="va">theta.location</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/chol.html" class="external-link">chol</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="op">-</span><span class="fl">.25</span>, <span class="op">-</span><span class="fl">.25</span>, <span class="fl">.5</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fl">2.5</span></span>
<span>    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">nGroups</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>ID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">nGroups</span><span class="op">)</span>, group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">1</span>, each <span class="op">=</span> <span class="va">nGroups</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">d</span> <span class="op">&lt;-</span> <span class="va">d</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">nObs</span>, size <span class="op">=</span> <span class="fl">1</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">ID</span>, <span class="va">group</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">nGroups</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">d</span><span class="op">[</span><span class="va">ID</span> <span class="op">==</span> <span class="va">i</span>, <span class="va">y</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span></span>
<span>        n <span class="op">=</span> <span class="va">nObs</span>,</span>
<span>        size <span class="op">=</span> <span class="fl">1</span>,</span>
<span>        prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">theta.location</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">theta.location</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">*</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/copy.html" class="external-link">copy</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Following the earlier example, we center our binary predictor,
<code>x</code> (whether participants experienced any stressor that day).
This separates the effects of experiencing a stressor within a person
from the fact that some people may experience stressors most days or
rarely experience any stressors. We call the between person variable,
the average proportion of days experiencing a stressor, <code>xb</code>.
We call the within person variable, <code>xw</code>. As in the example
on centering within person categorical variables, we also create a
dataset with the within person hypothetical values for each person,
<code>usewat</code>.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## within person centering binary predictor</span></span>
<span><span class="va">d</span><span class="op">[</span>, <span class="va">xb</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">ID</span><span class="op">]</span></span>
<span><span class="va">d</span><span class="op">[</span>, <span class="va">xw</span> <span class="op">:=</span> <span class="va">x</span> <span class="op">-</span> <span class="va">xb</span><span class="op">]</span></span>
<span></span>
<span><span class="va">xwid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/melt.data.table.html" class="external-link">melt</a></span><span class="op">(</span></span>
<span>  <span class="va">d</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>a <span class="op">=</span> <span class="fl">0</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="va">xb</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>        b <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="va">xb</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="va">ID</span><span class="op">]</span>, id.vars <span class="op">=</span> <span class="st">"ID"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">usewat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ID <span class="op">=</span> <span class="st">"ID"</span>, xw <span class="op">=</span> <span class="va">xwid</span><span class="op">)</span></span></code></pre></div>
<p>Group is measured between people so we do not need to center it. We
include a random slope by <code>xw</code> (within person experience or
not of a stressor) and an interaction between <code>xw</code> and
<code>Group</code> to evaluate whether the association between
experiencing a stressor on a given day, at the within person level, is
associated with a good or poor night sleep and whether that differs
between people randomized to the waitlist control or the intervention.
The model can be fit as in the following code.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mlogitcentint</span> <span class="op">&lt;-</span> <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/brm.html" class="external-link">brm</a></span><span class="op">(</span></span>
<span>  <span class="va">y</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">xw</span> <span class="op">*</span> <span class="va">group</span> <span class="op">+</span> <span class="va">xb</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">xw</span> <span class="op">|</span> <span class="va">ID</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"bernoulli"</span>,</span>
<span>  data <span class="op">=</span> <span class="va">d</span>, seed <span class="op">=</span> <span class="fl">1234</span>,</span>
<span>  save_pars <span class="op">=</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/save_pars.html" class="external-link">save_pars</a></span><span class="op">(</span>group <span class="op">=</span> <span class="cn">TRUE</span>, latent <span class="op">=</span> <span class="cn">FALSE</span>, all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  silent <span class="op">=</span> <span class="fl">2</span>, refresh <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4L</span>, cores <span class="op">=</span> <span class="fl">4L</span>, backend <span class="op">=</span> <span class="st">"cmdstanr"</span><span class="op">)</span></span></code></pre></div>
<p>We will generate average marginal predicted probabilities for each
group and with within person stressor exposure held at none and any. The
grid of possibilities is created and stored in <code>use.at</code> and
shown in the following table.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">use.at</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>group <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">1</span>, xw <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">use.at</span>, digits <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">group</th>
<th align="left">xw</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">0</td>
<td align="left">a</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="left">a</td>
</tr>
<tr class="odd">
<td align="right">0</td>
<td align="left">b</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="left">b</td>
</tr>
</tbody>
</table>
<p>From this grid, there are three contrasts of interest.</p>
<ol style="list-style-type: decimal">
<li>What is the average marginal effect (AME) of within person stressor
exposure on good or poor sleep that night if everyone were randomized to
the waitlist control group?</li>
<li>What is the AME of within person stressor exposure on good or poor
sleep that night if everyone were randomized to the intervention
group?</li>
<li>What is the difference in the AME of within person stressor exposure
between the intervention and waitlist control group?</li>
</ol>
<p>A quick way to create this contrast matrix is to start with our
contrast codes for the AME: -1 and +1. We use the kronecker product with
a 2 x 2 identity matrix to expand this into the contrast codes needed
for our 1st and 2nd questions. Then we take the difference in contrast
weights between these two which are the weights for the 3rd question.
The code to do this and the resulting contrast matrix with labels is
shown in the following code and table.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">contr.mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>xw <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/kronecker.html" class="external-link">%x%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">contr.mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span></span>
<span>  <span class="va">contr.mat</span>,</span>
<span>  <span class="va">contr.mat</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">contr.mat</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">contr.mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"AME xw: Grp "</span>, <span class="fl">0</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>  <span class="st">"delta AME xw"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">contr.mat</span>, digits <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">AME xw: Grp 0</th>
<th align="right">AME xw: Grp 1</th>
<th align="right">delta AME xw</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">-1</td>
<td align="right">0</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="right">0</td>
<td align="right">-1</td>
<td align="right">-1</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">-1</td>
</tr>
<tr class="even">
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1</td>
</tr>
</tbody>
</table>
<p>Now we can use <code><a href="../reference/brmsmargins.html">brmsmargins()</a></code> with the model, our grid of
values to generate average marginal predictions, and our contrast matrix
to generate the AMEs and answer our three questions. We specify here
that we want 95% credible intervals, and we specify the desired ROPE and
MID regions as well as the seed so that we can reproduce the results
exactly. Once run, we can see the average marginal predictions for our
grid of values in <code>use.at</code> in the following table.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ame.centint</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brmsmargins.html">brmsmargins</a></span><span class="op">(</span></span>
<span>  object <span class="op">=</span> <span class="va">mlogitcentint</span>,</span>
<span>  at <span class="op">=</span> <span class="va">use.at</span>,</span>
<span>  wat <span class="op">=</span> <span class="va">usewat</span>,</span>
<span>  contrasts <span class="op">=</span> <span class="va">contr.mat</span>, CI <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>  ROPE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">.02</span>, <span class="fl">.02</span><span class="op">)</span>, MID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">.05</span>, <span class="fl">.05</span><span class="op">)</span>,</span>
<span>  effects <span class="op">=</span> <span class="st">"integrateoutRE"</span>, k <span class="op">=</span> <span class="fl">20L</span>, seed <span class="op">=</span> <span class="fl">1234</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">ame.centint</span><span class="op">$</span><span class="va">Summary</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">M</span>, <span class="va">LL</span>, <span class="va">UL</span>, <span class="va">CI</span>, <span class="va">CIType</span><span class="op">)</span><span class="op">]</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">M</th>
<th align="right">LL</th>
<th align="right">UL</th>
<th align="right">CI</th>
<th align="left">CIType</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">0.116</td>
<td align="right">0.054</td>
<td align="right">0.187</td>
<td align="right">0.95</td>
<td align="left">HDI</td>
</tr>
<tr class="even">
<td align="right">0.143</td>
<td align="right">0.070</td>
<td align="right">0.213</td>
<td align="right">0.95</td>
<td align="left">HDI</td>
</tr>
<tr class="odd">
<td align="right">0.045</td>
<td align="right">0.017</td>
<td align="right">0.079</td>
<td align="right">0.95</td>
<td align="left">HDI</td>
</tr>
<tr class="even">
<td align="right">0.267</td>
<td align="right">0.170</td>
<td align="right">0.379</td>
<td align="right">0.95</td>
<td align="left">HDI</td>
</tr>
</tbody>
</table>
<p>Finally we can look at the contrast summary to answer our three
questions of interest: the two simple AMEs of within person stressor
exposure and the difference between intervention conditions in those
AMEs. These are shown in the following table.</p>
<p>From the results, we can see that if everyone were randomized to the
waitlist control group, we would expect a lower probability of a good
night sleep on stressor compared to non stressor days, at the within
person level. This effect is unlikely to be practically equivalent to 0
(&lt; 5% of the posterior falls in the ROPE) but it also is not clearly
exceeding the MID with &lt; 90% of the posterior distribution exceeding
the MID.</p>
<p>In comparison, if everyone were randomized to the intervention group,
we would expect a better night sleep on stressor compared to non
stressor days at the within person level. This is unlikely to be an
effect practically equivalent to zero (&lt; 5% of the posterior falls in
the ROPE) and is likely to be at least a MID, as most of the posterior
exceeds the MID.</p>
<p>Finally, we can see that the difference in the AMEs between the
control and intervention groups is quite large, with none of the
posterior distribution falling in the ROPE and nearly all of it
exceeding the MID.</p>
<p>We can also see that our contrast coding did indeed yield the
difference between the two simple AMEs and can confirm with ‚Äòby hand‚Äô
calculations that the mean contrast estimate for the group difference is
indeed the mean for the AME for the intervention (Grp 1) minus the mean
for the AME for the waitlist control (Grp 0). Collectively, this
suggests that within people, days they are exposed to a stressor or not
is associated with their sleep that night, and that the emotion
regulation intervention moderates the association between within person
stressor exposure and sleep.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">ame.centint</span><span class="op">$</span><span class="va">ContrastSummary</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="5%">
<col width="5%">
<col width="5%">
<col width="5%">
<col width="9%">
<col width="8%">
<col width="4%">
<col width="5%">
<col width="11%">
<col width="26%">
<col width="11%">
</colgroup>
<thead><tr class="header">
<th align="right">M</th>
<th align="right">Mdn</th>
<th align="right">LL</th>
<th align="right">UL</th>
<th align="right">PercentROPE</th>
<th align="right">PercentMID</th>
<th align="right">CI</th>
<th align="left">CIType</th>
<th align="left">ROPE</th>
<th align="left">MID</th>
<th align="left">Label</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">-0.072</td>
<td align="right">-0.069</td>
<td align="right">-0.134</td>
<td align="right">-0.012</td>
<td align="right">3.175</td>
<td align="right">73.675</td>
<td align="right">0.95</td>
<td align="left">HDI</td>
<td align="left">[-0.02, 0.02]</td>
<td align="left">[-Inf, -0.05] | [0.05, Inf]</td>
<td align="left">AME xw: Grp 0</td>
</tr>
<tr class="even">
<td align="right">0.123</td>
<td align="right">0.122</td>
<td align="right">0.039</td>
<td align="right">0.211</td>
<td align="right">0.775</td>
<td align="right">96.100</td>
<td align="right">0.95</td>
<td align="left">HDI</td>
<td align="left">[-0.02, 0.02]</td>
<td align="left">[-Inf, -0.05] | [0.05, Inf]</td>
<td align="left">AME xw: Grp 1</td>
</tr>
<tr class="odd">
<td align="right">0.195</td>
<td align="right">0.192</td>
<td align="right">0.096</td>
<td align="right">0.297</td>
<td align="right">0.025</td>
<td align="right">99.850</td>
<td align="right">0.95</td>
<td align="left">HDI</td>
<td align="left">[-0.02, 0.02]</td>
<td align="left">[-Inf, -0.05] | [0.05, Inf]</td>
<td align="left">delta AME xw</td>
</tr>
</tbody>
</table>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Potentially useful references.</p>
<ul>
<li>Hedeker, D., du Toit, S. H., Demirtas, H., &amp; Gibbons, R. D.
(2018). A note on marginalization of regression parameters from mixed
models of binary outcomes. <em>Biometrics, 74</em>(1), 354-361.</li>
<li>Hua, H., Burke, D. L., Crowther, M. J., Ensor, J., Tudur Smith, C.,
&amp; Riley, R. D. (2017). One-stage individual participant data
meta-analysis models: estimation of treatment-covariate interactions
must avoid ecological bias by separating out within-trial and
across-trial information. <em>Statistics in Medicine, 36</em>(5),
772‚Äì789. <a href="https://doi.org/10.1002/sim.7171" class="external-link uri">https://doi.org/10.1002/sim.7171</a>
</li>
<li>Mize, T. D., Doan, L., &amp; Long, J. S. (2019). A general framework
for comparing predictions and marginal effects across models.
<em>Sociological Methodology, 49</em>(1), 152-189.</li>
<li>Norton, E. C., Dowd, B. E., &amp; Maciejewski, M. L. (2019).
Marginal effects‚Äîquantifying the effect of changes in risk factors in
logistic regression models. <em>JAMA, 321</em>(13), 1304-1305.</li>
<li>Pavlou, M., Ambler, G., Seaman, S., &amp; Omar, R. Z. (2015). A note
on obtaining correct marginal predictions from a random intercepts model
for binary outcomes. <em>BMC Medical Research Methodology, 15</em>(1),
1-6.</li>
<li>Yaremych, H. E., Preacher, K. J., &amp; Hedeker, D. (2021).
Centering categorical predictors in multilevel models: Best practices
and interpretation. <em>Psychological Methods</em>. <a href="https://doi.org/10.1037/met0000434" class="external-link uri">https://doi.org/10.1037/met0000434</a>
</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://joshuawiley.com" class="external-link">Joshua F. Wiley</a>, Donald Hedeker.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
